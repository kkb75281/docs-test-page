<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>비밀번호 찾기 페이지</title>
    </head>
    <link rel="stylesheet" href="style.css" />
    <body>
        <a class="btn home" href="index.html">홈으로</a>
        <p id="loggedUser"></p>
        <h1>비밀번호 찾기</h1>

        <!-- Step 1: Request verification code -->
        <div id="step1">
            <h4>인증 코드를 요청하세요</h4>
            <form class="form" onsubmit="requestCode(event)">
                <input
                    id="emailInput"
                    type="email"
                    name="email"
                    placeholder="E-Mail"
                    required
                />
                <input type="submit" value="Request Verification Code" />
            </form>
        </div>

        <!-- Step 2: Reset password (hidden initially) -->
        <div id="step2" style="display: none">
            <h4>인증 코드로 비밀번호 재설정하기</h4>
            <form class="form" onsubmit="resetPassword(event)">
                <input
                    type="text"
                    name="code"
                    placeholder="Verification Code"
                    required
                />
                <input
                    type="password"
                    name="new_password"
                    placeholder="New Password"
                    required
                />
                <input type="submit" value="Change Password" />
            </form>
        </div>
    </body>
    <script src="https://cdn.jsdelivr.net/npm/skapi-js@latest/dist/skapi.js"></script>
    <script src="service.js"></script>
    <script>
        let userEmail = "";

        function requestCode(event) {
            event.preventDefault();
            userEmail = document.getElementById("emailInput").value;

            skapi
                .forgotPassword({ email: userEmail })
                .then((res) => {
                    console.log(res); // SUCCESS: Verification code has been sent.
                    // Hide step 1, show step 2
                    document.getElementById("step1").style.display = "none";
                    document.getElementById("step2").style.display = "block";
                })
                .catch((err) => {
                    console.error(err);
                    alert("오류가 발생했습니다: " + err.message);
                });
        }

        function resetPassword(event) {
            event.preventDefault();
            const form = event.target;
            const code = form.code.value;
            const new_password = form.new_password.value;

            skapi
                .resetPassword({
                    email: userEmail,
                    code: code,
                    new_password: new_password,
                })
                .then((res) => {
                    console.log(res); // SUCCESS: New password has been set.
                    alert("비밀번호가 성공적으로 변경되었습니다!");
                    window.location.href = "login.html";
                })
                .catch((err) => {
                    console.error(err);
                    alert("오류가 발생했습니다: " + err.message);
                });
        }
    </script>
</html>
