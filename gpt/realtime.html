<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Skapi Realtime Test</title>
        <link rel="stylesheet" href="style.css" />
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }
            .container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-top: 20px;
            }
            .panel {
                border: 1px solid #ccc;
                border-radius: 8px;
                padding: 20px;
                background-color: #f9f9f9;
            }
            .panel h2 {
                margin-top: 0;
            }
            #messageLog {
                height: 400px;
                overflow-y: auto;
                background-color: #fff;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 10px;
                font-family: monospace;
                font-size: 12px;
            }
            .message-item {
                margin-bottom: 10px;
                padding: 8px;
                border-radius: 4px;
                border-left: 3px solid #ccc;
            }
            .message-item.type-success {
                background-color: #d4edda;
                border-left-color: #28a745;
            }
            .message-item.type-message {
                background-color: #d1ecf1;
                border-left-color: #17a2b8;
            }
            .message-item.type-private {
                background-color: #e7d1f8;
                border-left-color: #6f42c1;
            }
            .message-item.type-notice {
                background-color: #fff3cd;
                border-left-color: #ffc107;
            }
            .message-item.type-error {
                background-color: #f8d7da;
                border-left-color: #dc3545;
            }
            .message-item.type-close {
                background-color: #e2e3e5;
                border-left-color: #6c757d;
            }
            .message-item.type-reconnect {
                background-color: #cfe2ff;
                border-left-color: #0d6efd;
            }
            .message-header {
                font-weight: bold;
                margin-bottom: 4px;
            }
            .message-time {
                color: #666;
                font-size: 11px;
            }
            .status-indicator {
                display: inline-block;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                margin-right: 8px;
            }
            .status-indicator.connected {
                background-color: #28a745;
            }
            .status-indicator.disconnected {
                background-color: #dc3545;
            }
            .user-info {
                background-color: #e9ecef;
                padding: 10px;
                border-radius: 4px;
                margin-bottom: 15px;
                font-size: 14px;
            }
            button {
                padding: 10px 20px;
                margin: 5px 5px 5px 0;
                border: none;
                border-radius: 4px;
                background-color: #007bff;
                color: white;
                font-size: 14px;
            }
            button:hover {
                background-color: #0056b3;
            }
            button:disabled {
                background-color: #6c757d;
                cursor: not-allowed;
            }
            button.danger {
                background-color: #dc3545;
            }
            button.danger:hover {
                background-color: #c82333;
            }
            input[type="text"],
            textarea {
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 14px;
            }
            .form-group {
                margin-bottom: 15px;
            }
            .form-group label {
                margin-bottom: 5px;
                font-weight: bold;
            }

            /* WebRTC Styles */
            .video-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
                margin-top: 15px;
            }
            .video-wrapper {
                text-align: center;
            }
            .video-wrapper video {
                width: 100%;
                max-width: 320px;
                height: 240px;
                border: 2px solid #ddd;
                border-radius: 8px;
                background-color: #000;
            }
            .video-wrapper label {
                display: block;
                margin-top: 8px;
                font-weight: bold;
                font-size: 14px;
            }
            dialog {
                border: 2px solid #007bff;
                border-radius: 8px;
                padding: 30px;
                min-width: 300px;
            }
            dialog p {
                margin-top: 0;
                font-size: 18px;
                font-weight: bold;
            }
            dialog::backdrop {
                background-color: rgba(0, 0, 0, 0.5);
            }
            .user-list {
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 10px;
                margin-top: 10px;
            }
            .user-item {
                padding: 8px;
                margin-bottom: 5px;
                background-color: #fff;
                border-radius: 4px;
                border: 1px solid #e0e0e0;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .user-item button {
                padding: 5px 15px;
                font-size: 12px;
                margin: 0;
            }
        </style>
    </head>
    <body>
        <a class="btn home" href="/index.html">í™ˆìœ¼ë¡œ</a>
        <h1>ğŸ”´ Skapi Realtime Connection Test</h1>

        <div class="user-info">
            <strong>Logged User:</strong>
            <span id="loggedUser">Not logged in</span>
        </div>

        <!-- Test Guide Panel -->
        <div
            class="panel"
            style="
                background-color: #fff3cd;
                border-color: #ffc107;
                margin-bottom: 20px;
            "
        >
            <h2>ğŸ“‹ Realtime í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ</h2>

            <details open>
                <summary
                    style="
                        cursor: pointer;
                        font-weight: bold;
                        margin-bottom: 10px;
                    "
                >
                    ğŸ¯ ê¸°ë³¸ Realtime ì—°ê²° í…ŒìŠ¤íŠ¸
                </summary>
                <ol style="line-height: 1.8">
                    <li>
                        <strong>ë‘ ê°œì˜ ë¸Œë¼ìš°ì € ì°½ ì¤€ë¹„</strong>
                        <ul>
                            <li>ì°½ 1: í˜„ì¬ ì°½ ì‚¬ìš©</li>
                            <li>
                                ì°½ 2: ìƒˆ ì°½/íƒ­ ì—´ê¸° (ê°™ì€ í˜ì´ì§€ ë˜ëŠ” ì‹œí¬ë¦¿
                                ëª¨ë“œ)
                            </li>
                            <li>
                                ğŸ’¡ ì‹œí¬ë¦¿ ëª¨ë“œ ì‚¬ìš© ì‹œ ë‹¤ë¥¸ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ê°€ëŠ¥
                            </li>
                        </ul>
                    </li>
                    <li>
                        <strong>ë‘ ì°½ ëª¨ë‘ ì—°ê²°</strong>
                        <ul>
                            <li>
                                Group Name: <code>testroom</code> (ê°™ì€ ê·¸ë£¹ëª…
                                ì…ë ¥)
                            </li>
                            <li>"Connect Realtime" í´ë¦­</li>
                            <li>âœ… ìƒíƒœê°€ "Connected"ë¡œ ë³€ê²½ë˜ëŠ”ì§€ í™•ì¸</li>
                        </ul>
                    </li>
                    <li>
                        <strong>ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸</strong>
                        <ul>
                            <li>
                                ì°½ 1ì—ì„œ Broadcast Message ì…ë ¥:
                                <code>ì•ˆë…•í•˜ì„¸ìš”!</code>
                            </li>
                            <li>"Send to Group" í´ë¦­</li>
                            <li>
                                âœ… ì°½ 2ì˜ Message Logì— ë©”ì‹œì§€ê°€ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
                            </li>
                            <li>
                                âœ… ì–‘ë°©í–¥ í…ŒìŠ¤íŠ¸: ì°½ 2ì—ì„œë„ ë©”ì‹œì§€ ì „ì†¡í•´ë³´ê¸°
                            </li>
                        </ul>
                    </li>
                    <li>
                        <strong>ì—°ê²° í•´ì œ</strong>
                        <ul>
                            <li>"Disconnect" í´ë¦­</li>
                            <li>âœ… ìƒíƒœê°€ "Disconnected"ë¡œ ë³€ê²½ë˜ëŠ”ì§€ í™•ì¸</li>
                        </ul>
                    </li>
                </ol>
            </details>

            <details style="margin-top: 15px">
                <summary
                    style="
                        cursor: pointer;
                        font-weight: bold;
                        margin-bottom: 10px;
                    "
                >
                    ğŸ’¬ Private Message (1:1 ë©”ì‹œì§€) í…ŒìŠ¤íŠ¸
                </summary>
                <ol style="line-height: 1.8">
                    <li>
                        <strong>ì‚¬ìš©ì ID í™•ì¸</strong>
                        <ul>
                            <li>ë‘ ì°½ ëª¨ë‘ ê°™ì€ ê·¸ë£¹ì— ì—°ê²°</li>
                            <li>"í˜„ì¬ ê·¸ë£¹ ì‚¬ìš©ì ë³´ê¸°" í´ë¦­</li>
                            <li>Message Logì—ì„œ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ user_id ë³µì‚¬</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Private Message ì „ì†¡</strong>
                        <ul>
                            <li>Recipient user IDì— ìƒëŒ€ë°© user_id ë¶™ì—¬ë„£ê¸°</li>
                            <li>
                                Private Message ì…ë ¥:
                                <code>ê°œì¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤</code>
                            </li>
                            <li>"Send Private Message" í´ë¦­</li>
                        </ul>
                    </li>
                    <li>
                        <strong>í™•ì¸</strong>
                        <ul>
                            <li>
                                âœ… ìˆ˜ì‹ ì ì°½ì—ë§Œ ë³´ë¼ìƒ‰ ë°°ê²½ì˜ Private ë©”ì‹œì§€
                                í‘œì‹œ
                            </li>
                            <li>âœ… ê·¸ë£¹ ë‚´ ë‹¤ë¥¸ ì‚¬ìš©ìëŠ” ë©”ì‹œì§€ ìˆ˜ì‹  ì•ˆ ë¨</li>
                        </ul>
                    </li>
                </ol>
            </details>

            <details style="margin-top: 15px">
                <summary
                    style="
                        cursor: pointer;
                        font-weight: bold;
                        margin-bottom: 10px;
                    "
                >
                    ğŸ”„ ê·¸ë£¹ ê´€ë¦¬ í…ŒìŠ¤íŠ¸
                </summary>
                <ol style="line-height: 1.8">
                    <li>
                        <strong>ì—¬ëŸ¬ ê·¸ë£¹ ìƒì„±</strong>
                        <ul>
                            <li>ì°½ 1: <code>room1</code> ê·¸ë£¹ ì—°ê²°</li>
                            <li>ì°½ 2: <code>room2</code> ê·¸ë£¹ ì—°ê²°</li>
                            <li>ì°½ 3: <code>room1</code> ê·¸ë£¹ ì—°ê²°</li>
                        </ul>
                    </li>
                    <li>
                        <strong>ê·¸ë£¹ë³„ ë©”ì‹œì§€ ê²©ë¦¬ í™•ì¸</strong>
                        <ul>
                            <li>ì°½ 1ì—ì„œ ë©”ì‹œì§€ ì „ì†¡</li>
                            <li>âœ… ì°½ 3ì—ë§Œ ë©”ì‹œì§€ ìˆ˜ì‹  (ê°™ì€ ê·¸ë£¹)</li>
                            <li>âœ… ì°½ 2ëŠ” ë©”ì‹œì§€ ìˆ˜ì‹  ì•ˆ ë¨ (ë‹¤ë¥¸ ê·¸ë£¹)</li>
                        </ul>
                    </li>
                    <li>
                        <strong>ê·¸ë£¹ ë³€ê²½</strong>
                        <ul>
                            <li>
                                ì°½ 2ì—ì„œ "ê·¸ë£¹ ë³€ê²½/ë‚˜ê°€ê¸°" ì…ë ¥ë€ì—
                                <code>room1</code> ì…ë ¥
                            </li>
                            <li>"ê·¸ë£¹ ë³€ê²½/ë‚˜ê°€ê¸°" í´ë¦­</li>
                            <li>âœ… í˜„ì¬ ê·¸ë£¹ì´ room1ë¡œ ë³€ê²½ë¨</li>
                            <li>âœ… ì´ì œ ì°½ 1, 2, 3 ëª¨ë‘ ë©”ì‹œì§€ ê³µìœ </li>
                        </ul>
                    </li>
                    <li>
                        <strong>ê·¸ë£¹ ë‚˜ê°€ê¸°</strong>
                        <ul>
                            <li>ì…ë ¥ë€ ë¹„ìš°ê³  "ê·¸ë£¹ ë³€ê²½/ë‚˜ê°€ê¸°" í´ë¦­</li>
                            <li>âœ… í˜„ì¬ ê·¸ë£¹: "-" í‘œì‹œ</li>
                            <li>âœ… ë©”ì‹œì§€ ìˆ˜ì‹  ì•ˆ ë¨</li>
                        </ul>
                    </li>
                    <li>
                        <strong>ì „ì²´ ê·¸ë£¹ ëª©ë¡</strong>
                        <ul>
                            <li>"ì „ì²´ ê·¸ë£¹ ëª©ë¡ ë³´ê¸°" í´ë¦­</li>
                            <li>âœ… í™œì„±í™”ëœ ëª¨ë“  ê·¸ë£¹ê³¼ ì‚¬ìš©ì ìˆ˜ í‘œì‹œ</li>
                        </ul>
                    </li>
                </ol>
            </details>

            <details style="margin-top: 15px">
                <summary
                    style="
                        cursor: pointer;
                        font-weight: bold;
                        margin-bottom: 10px;
                    "
                >
                    ğŸ“ WebRTC Video Call í…ŒìŠ¤íŠ¸
                </summary>
                <ol style="line-height: 1.8">
                    <li>
                        <strong>ì‚¬ì „ ì¤€ë¹„</strong>
                        <ul>
                            <li>âš ï¸ ì¹´ë©”ë¼/ë§ˆì´í¬ ê¶Œí•œ í—ˆìš© í•„ìš”</li>
                            <li>ë‘ ì°½ ëª¨ë‘ ê°™ì€ ê·¸ë£¹ì— ì—°ê²°</li>
                            <li>"í˜„ì¬ ê·¸ë£¹ ì‚¬ìš©ì ë³´ê¸°"ë¡œ ì°¸ê°€ì í™•ì¸</li>
                        </ul>
                    </li>
                    <li>
                        <strong>ì˜ìƒ í†µí™” ì‹œì‘</strong>
                        <ul>
                            <li>ì°½ 1: ì‚¬ìš©ì ëª©ë¡ì—ì„œ "Call" ë²„íŠ¼ í´ë¦­</li>
                            <li>
                                ì°½ 2: "í†µí™” ìš”ì²­" ë‹¤ì´ì–¼ë¡œê·¸ì—ì„œ "Accept" í´ë¦­
                            </li>
                        </ul>
                    </li>
                    <li>
                        <strong>í†µí™” í™•ì¸</strong>
                        <ul>
                            <li>âœ… "ë‚´ í™”ë©´"ì— ë³¸ì¸ ì˜ìƒ í‘œì‹œ</li>
                            <li>âœ… "ìƒëŒ€ë°© í™”ë©´"ì— ìƒëŒ€ë°© ì˜ìƒ í‘œì‹œ</li>
                            <li>âœ… ìŒì„± í†µí™” ê°€ëŠ¥</li>
                        </ul>
                    </li>
                    <li>
                        <strong>í†µí™” ì¢…ë£Œ</strong>
                        <ul>
                            <li>"í†µí™” ì¢…ë£Œ" ë²„íŠ¼ í´ë¦­</li>
                            <li>âœ… ì˜ìƒ ìŠ¤íŠ¸ë¦¼ ì •ì§€</li>
                            <li>âœ… ìƒëŒ€ë°©ë„ í†µí™” ì¢…ë£Œ ë©”ì‹œì§€ ìˆ˜ì‹ </li>
                        </ul>
                    </li>
                </ol>

                <div
                    style="
                        background-color: #f8d7da;
                        border: 1px solid #dc3545;
                        border-radius: 4px;
                        padding: 10px;
                        margin-top: 10px;
                    "
                >
                    <strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong>
                    <ul style="margin: 5px 0">
                        <li>WebRTCëŠ” HTTPS í™˜ê²½ ë˜ëŠ” localhostì—ì„œë§Œ ì‘ë™</li>
                        <li>ë°©í™”ë²½/NAT í™˜ê²½ì— ë”°ë¼ ì—°ê²° ì‹¤íŒ¨ ê°€ëŠ¥</li>
                        <li>ê°™ì€ ë„¤íŠ¸ì›Œí¬ì—ì„œ í…ŒìŠ¤íŠ¸ ê¶Œì¥</li>
                    </ul>
                </div>
            </details>

            <details style="margin-top: 15px">
                <summary
                    style="
                        cursor: pointer;
                        font-weight: bold;
                        margin-bottom: 10px;
                    "
                >
                    ğŸ”” Push Notification í…ŒìŠ¤íŠ¸
                </summary>
                <ol style="line-height: 1.8">
                    <li>
                        <strong>ì•Œë¦¼ ê¶Œí•œ ìš”ì²­</strong>
                        <ul>
                            <li>"Enable Push Notifications" í´ë¦­</li>
                            <li>ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ í—ˆìš©</li>
                            <li>âœ… "Push notifications enabled" ë©”ì‹œì§€ í™•ì¸</li>
                        </ul>
                    </li>
                    <li>
                        <strong>ì•Œë¦¼ í…ŒìŠ¤íŠ¸</strong>
                        <ul>
                            <li>
                                ì°½ 1: Realtime ì—°ê²° ìƒíƒœì—ì„œ ë¸Œë¼ìš°ì € ì°½
                                ìµœì†Œí™”/ë°±ê·¸ë¼ìš´ë“œ
                            </li>
                            <li>ì°½ 2: ë©”ì‹œì§€ ì „ì†¡</li>
                            <li>âœ… ì°½ 1ì— ë°ìŠ¤í¬í†± ì•Œë¦¼ í‘œì‹œ</li>
                        </ul>
                    </li>
                    <li>
                        <strong>ì•Œë¦¼ ë¹„í™œì„±í™”</strong>
                        <ul>
                            <li>"Disable Notifications" í´ë¦­</li>
                            <li>âœ… ë” ì´ìƒ í‘¸ì‹œ ì•Œë¦¼ ìˆ˜ì‹  ì•ˆ ë¨</li>
                        </ul>
                    </li>
                </ol>

                <div
                    style="
                        background-color: #fff3cd;
                        border: 1px solid #ffc107;
                        border-radius: 4px;
                        padding: 10px;
                        margin-top: 10px;
                    "
                >
                    <strong>ğŸ’¡ Tip:</strong>
                    <ul style="margin: 5px 0">
                        <li>ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì•Œë¦¼ì´ í—ˆìš©ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸</li>
                        <li>ì¼ë¶€ ë¸Œë¼ìš°ì €ëŠ” HTTPSì—ì„œë§Œ ì•Œë¦¼ ì§€ì›</li>
                    </ul>
                </div>
            </details>

            <details style="margin-top: 15px">
                <summary
                    style="
                        cursor: pointer;
                        font-weight: bold;
                        margin-bottom: 10px;
                    "
                >
                    ğŸ¨ ê³ ê¸‰ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸
                </summary>
                <ol style="line-height: 1.8">
                    <li>
                        <strong>ì±„íŒ…ë°© ì• í”Œë¦¬ì¼€ì´ì…˜</strong>
                        <ul>
                            <li>3ëª… ì´ìƒì´ ê°™ì€ ê·¸ë£¹ ì—°ê²°</li>
                            <li>Broadcastë¡œ ì „ì²´ ì±„íŒ…</li>
                            <li>Private Messageë¡œ ê·“ì†ë§</li>
                            <li>ê·¸ë£¹ ì‚¬ìš©ì ëª©ë¡ìœ¼ë¡œ ì°¸ê°€ì í™•ì¸</li>
                        </ul>
                    </li>
                    <li>
                        <strong>íŒ€ í˜‘ì—… ë„êµ¬</strong>
                        <ul>
                            <li>
                                ê·¸ë£¹ëª…: <code>team-dev</code>,
                                <code>team-design</code>
                            </li>
                            <li>íŒ€ë³„ë¡œ ë¶„ë¦¬ëœ ë©”ì‹œì§•</li>
                            <li>íŒ€ì› ê°„ ì˜ìƒ íšŒì˜</li>
                            <li>ì¤‘ìš” ë©”ì‹œì§€ëŠ” Private Message í™œìš©</li>
                        </ul>
                    </li>
                    <li>
                        <strong>ê²Œì„ ë¡œë¹„</strong>
                        <ul>
                            <li>ê·¸ë£¹ëª…: <code>game-lobby-1</code></li>
                            <li>í”Œë ˆì´ì–´ ì…ì¥/í‡´ì¥ í™•ì¸ (ê·¸ë£¹ ì‚¬ìš©ì ë³´ê¸°)</li>
                            <li>ê²Œì„ ì‹œì‘ ì‹ í˜¸ Broadcast</li>
                            <li>ì „ì²´ ê·¸ë£¹ ëª©ë¡ìœ¼ë¡œ í™œì„± ë¡œë¹„ í™•ì¸</li>
                        </ul>
                    </li>
                    <li>
                        <strong>ì¬ì—°ê²° í…ŒìŠ¤íŠ¸</strong>
                        <ul>
                            <li>ì—°ê²° ì¤‘ ë„¤íŠ¸ì›Œí¬ ì¼ì‹œ ì¤‘ë‹¨ (Wi-Fi ë„ê¸°)</li>
                            <li>ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ (Wi-Fi ì¼œê¸°)</li>
                            <li>âœ… ìë™ ì¬ì—°ê²° ì‹œë„ í™•ì¸</li>
                            <li>âœ… Message Logì— reconnect ë©”ì‹œì§€ í‘œì‹œ</li>
                        </ul>
                    </li>
                </ol>
            </details>

            <div
                style="
                    background-color: #d1ecf1;
                    border: 1px solid #17a2b8;
                    border-radius: 4px;
                    padding: 10px;
                    margin-top: 15px;
                "
            >
                <strong>ğŸ” ë””ë²„ê¹… íŒ:</strong>
                <ul style="margin: 5px 0">
                    <li>
                        <strong>Message Log í™œìš©:</strong> ëª¨ë“  ì´ë²¤íŠ¸ê°€
                        íƒ€ì„ìŠ¤íƒ¬í”„ì™€ í•¨ê»˜ ê¸°ë¡ë¨
                    </li>
                    <li>
                        <strong>ìƒ‰ìƒ êµ¬ë¶„:</strong> ë…¹ìƒ‰(ì„±ê³µ), íŒŒë‘(ë©”ì‹œì§€),
                        ë³´ë¼(Private), ë…¸ë‘(ê³µì§€), ë¹¨ê°•(ì—ëŸ¬)
                    </li>
                    <li>
                        <strong>ë¸Œë¼ìš°ì € ì½˜ì†”:</strong> F12 > Consoleì—ì„œ ìƒì„¸
                        ë¡œê·¸ í™•ì¸
                    </li>
                    <li>
                        <strong>ì—°ê²° ìƒíƒœ:</strong> ì¢Œì¸¡ ë™ê·¸ë¼ë¯¸ ì¸ë””ì¼€ì´í„°
                        í™•ì¸ (ë…¹ìƒ‰=ì—°ê²°, ë¹¨ê°•=ëŠê¹€)
                    </li>
                </ul>
            </div>
        </div>

        <div class="panel">
            <h2>
                <span class="status-indicator" id="statusIndicator"></span>
                Connection Status:
                <span id="connectionStatus">Disconnected</span>
            </h2>
            <div class="form-group">
                <label>Group Name (ì—°ê²°í•˜ë ¤ëŠ” ê·¸ë£¹ëª… ì…ë ¥):</label>
                <input
                    type="text"
                    id="groupInput"
                    placeholder="ì˜ˆ: chatroom1, team-alpha ë“± (ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ê·¸ë£¹)"
                />
            </div>
            <div style="margin-bottom: 15px">
                <button id="connectBtn" onclick="handleConnect()">
                    Connect Realtime
                </button>
                <button
                    id="disconnectBtn"
                    onclick="handleDisconnect()"
                    disabled
                >
                    Disconnect
                </button>
            </div>

            <div class="form-group" id="groupManagement" style="display: none">
                <label
                    >í˜„ì¬ ê·¸ë£¹: <strong id="currentGroupName">-</strong></label
                >
                <hr style="margin: 10px 0" />
                <label>ê·¸ë£¹ ë³€ê²½/ë‚˜ê°€ê¸°:</label>
                <input
                    type="text"
                    id="changeGroupInput"
                    placeholder="ìƒˆ ê·¸ë£¹ëª… ì…ë ¥ (ë¹„ìš°ê³  ì‹¤í–‰í•˜ë©´ ê·¸ë£¹ ë‚˜ê°€ê¸°)"
                />
                <button onclick="changeGroup()" id="changeGroupBtn">
                    ê·¸ë£¹ ë³€ê²½/ë‚˜ê°€ê¸°
                </button>
            </div>
        </div>

        <div class="container">
            <!-- Control Panel -->
            <div class="panel">
                <h2>ğŸ“¤ Send Messages</h2>

                <div class="form-group">
                    <label>Broadcast Message:</label>
                    <textarea
                        id="messageInput"
                        rows="3"
                        placeholder="Enter message to broadcast"
                    ></textarea>
                    <button onclick="sendMessage()" id="sendBtn" disabled>
                        Send to Group
                    </button>
                </div>

                <hr />

                <div class="form-group">
                    <label>Private Message:</label>
                    <input
                        type="text"
                        id="recipientInput"
                        placeholder="Recipient user ID"
                    />
                    <textarea
                        id="privateMessageInput"
                        rows="3"
                        placeholder="Enter private message"
                    ></textarea>
                    <button
                        onclick="sendPrivateMessage()"
                        id="sendPrivateBtn"
                        disabled
                    >
                        Send Private Message
                    </button>
                </div>

                <hr />

                <h3>ğŸ” ê·¸ë£¹ ì •ë³´</h3>
                <div class="form-group">
                    <button onclick="listGroups()" id="listGroupsBtn">
                        ì „ì²´ ê·¸ë£¹ ëª©ë¡ ë³´ê¸°
                    </button>
                    <button
                        onclick="listUsersInGroup()"
                        id="listUsersBtn"
                        disabled
                    >
                        í˜„ì¬ ê·¸ë£¹ ì‚¬ìš©ì ë³´ê¸°
                    </button>
                </div>

                <hr />

                <h3>ğŸ“ WebRTC Video Call</h3>
                <div class="form-group">
                    <label>ê·¸ë£¹ ë‚´ ì‚¬ìš©ì ëª©ë¡:</label>
                    <div id="userList" class="user-list">
                        <p style="text-align: center; color: #666">
                            ê·¸ë£¹ì— ì°¸ê°€í•˜ë©´ ì‚¬ìš©ì ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤
                        </p>
                    </div>
                </div>

                <div class="video-container">
                    <div class="video-wrapper">
                        <video id="localVideo" autoplay muted></video>
                        <label>ë‚´ í™”ë©´</label>
                    </div>
                    <div class="video-wrapper">
                        <video id="remoteVideo" autoplay></video>
                        <label>ìƒëŒ€ë°© í™”ë©´</label>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px">
                    <button
                        onclick="endCall()"
                        id="endCallBtn"
                        disabled
                        class="danger"
                    >
                        í†µí™” ì¢…ë£Œ
                    </button>
                </div>

                <hr />

                <h3>ğŸ”” Push Notifications</h3>
                <div class="form-group">
                    <p
                        id="notificationStatus"
                        style="margin: 10px 0; font-weight: bold; color: #666"
                    >
                        ì•Œë¦¼ êµ¬ë… ìƒíƒœ: ë¯¸êµ¬ë…
                    </p>
                    <button
                        onclick="subscribeToNotifications()"
                        id="subscribeBtn"
                    >
                        ì•Œë¦¼ êµ¬ë…í•˜ê¸°
                    </button>
                    <button
                        onclick="unsubscribeFromNotifications()"
                        id="unsubscribeBtn"
                        disabled
                    >
                        ì•Œë¦¼ êµ¬ë… í•´ì œ
                    </button>
                </div>

                <div class="form-group">
                    <label>ì•Œë¦¼ê³¼ í•¨ê»˜ ë©”ì‹œì§€ ë³´ë‚´ê¸°:</label>
                    <input
                        type="text"
                        id="notifRecipientInput"
                        placeholder="ìˆ˜ì‹ ì User ID"
                    />
                    <input
                        type="text"
                        id="notifTitleInput"
                        placeholder="ì•Œë¦¼ ì œëª©"
                    />
                    <textarea
                        id="notifBodyInput"
                        rows="2"
                        placeholder="ì•Œë¦¼ ë‚´ìš©"
                    ></textarea>
                    <div class="checkbox-input">
                        <input type="checkbox" id="alwaysNotify" />
                        <label for="alwaysNotify"
                            >í•­ìƒ ì•Œë¦¼ ë³´ë‚´ê¸° (ì˜¨ë¼ì¸ ìƒíƒœì—ë„ ì•Œë¦¼)</label
                        >
                    </div>
                    <button
                        onclick="sendMessageWithNotification()"
                        id="sendNotifBtn"
                        disabled
                    >
                        ë©”ì‹œì§€ + ì•Œë¦¼ ì „ì†¡
                    </button>
                </div>

                <div
                    class="form-group"
                    id="adminNotifSection"
                    style="display: none"
                >
                    <label style="color: #dc3545"
                        >âš ï¸ Admin ì „ìš©: ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼</label
                    >
                    <input
                        type="text"
                        id="adminNotifTitle"
                        placeholder="ì•Œë¦¼ ì œëª©"
                    />
                    <textarea
                        id="adminNotifBody"
                        rows="2"
                        placeholder="ì•Œë¦¼ ë‚´ìš©"
                    ></textarea>
                    <input
                        type="text"
                        id="adminNotifTargets"
                        placeholder="íŠ¹ì • ì‚¬ìš©ì ID (ì„ íƒ, ì‰¼í‘œë¡œ êµ¬ë¶„)"
                    />
                    <button onclick="sendAdminNotification()" class="danger">
                        ê´€ë¦¬ì ì•Œë¦¼ ì „ì†¡
                    </button>
                </div>
            </div>

            <!-- Message Log -->
            <div class="panel">
                <h2>ğŸ“¨ Message Log</h2>
                <button onclick="clearLog()" style="margin-bottom: 10px">
                    Clear Log
                </button>
                <div id="messageLog"></div>
            </div>
        </div>

        <!-- RTC Call Dialog -->
        <dialog id="call_dialog"></dialog>

        <script src="https://cdn.jsdelivr.net/npm/skapi-js@latest/dist/skapi.js"></script>
        <script src="../service.js"></script>
        <script>
            let realtimeConnection = null;
            let currentGroup = null;
            let rtcConnection = null; // RTC connection object
            let notificationSubscription = null; // Notification subscription object

            // Check if user is admin and show admin notification section
            if (skapi.user && skapi.user.access_group >= 99) {
                document.getElementById("adminNotifSection").style.display =
                    "block";
            }

            // Update UI based on connection status
            function updateConnectionStatus(connected) {
                const statusIndicator =
                    document.getElementById("statusIndicator");
                const statusText = document.getElementById("connectionStatus");
                const connectBtn = document.getElementById("connectBtn");
                const disconnectBtn = document.getElementById("disconnectBtn");
                const sendBtn = document.getElementById("sendBtn");
                const sendPrivateBtn =
                    document.getElementById("sendPrivateBtn");
                const groupManagement =
                    document.getElementById("groupManagement");
                const currentGroupName =
                    document.getElementById("currentGroupName");
                const listUsersBtn = document.getElementById("listUsersBtn");

                if (connected) {
                    statusIndicator.className = "status-indicator connected";
                    statusText.textContent = "Connected";
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    sendBtn.disabled = false;
                    sendPrivateBtn.disabled = false;
                    groupManagement.style.display = "block";
                    currentGroupName.textContent = currentGroup || "-";
                    listUsersBtn.disabled = !currentGroup;
                } else {
                    statusIndicator.className = "status-indicator disconnected";
                    statusText.textContent = "Disconnected";
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    sendBtn.disabled = true;
                    sendPrivateBtn.disabled = true;
                    groupManagement.style.display = "none";
                    listUsersBtn.disabled = true;
                }
            }

            // Add message to log
            function addToLog(type, data) {
                const log = document.getElementById("messageLog");
                const messageItem = document.createElement("div");
                messageItem.className = `message-item type-${type}`;

                const time = new Date().toLocaleTimeString("ko-KR");
                let content = "";

                switch (type) {
                    case "success":
                        content = `<div class="message-header">âœ… ${type.toUpperCase()}</div>`;
                        content += `<div>${
                            data.message || "Connection successful"
                        }</div>`;
                        break;
                    case "message":
                        content = `<div class="message-header">ğŸ’¬ BROADCAST MESSAGE</div>`;
                        content += `<div><strong>From:</strong> ${
                            data.sender || "Unknown"
                        }</div>`;
                        if (data.sender_rid)
                            content += `<div><strong>Group:</strong> ${data.sender_rid}</div>`;
                        content += `<div><strong>Message:</strong> ${JSON.stringify(
                            data.message
                        )}</div>`;
                        break;
                    case "private":
                        content = `<div class="message-header">ğŸ”’ PRIVATE MESSAGE</div>`;
                        content += `<div><strong>From:</strong> ${
                            data.sender || "Unknown"
                        }</div>`;
                        content += `<div><strong>Message:</strong> ${JSON.stringify(
                            data.message
                        )}</div>`;
                        break;
                    case "notice":
                        content = `<div class="message-header">ğŸ“¢ NOTICE</div>`;
                        content += `<div><strong>Code:</strong> ${
                            data.code || "N/A"
                        }</div>`;
                        content += `<div><strong>Message:</strong> ${
                            data.message || "No message"
                        }</div>`;
                        if (data.sender)
                            content += `<div><strong>User:</strong> ${data.sender}</div>`;
                        break;
                    case "error":
                        content = `<div class="message-header">âŒ ERROR</div>`;
                        content += `<div>${
                            data.message || JSON.stringify(data)
                        }</div>`;
                        break;
                    case "close":
                        content = `<div class="message-header">ğŸ”Œ CONNECTION CLOSED</div>`;
                        content += `<div>${
                            data.message || "Connection closed"
                        }</div>`;
                        break;
                    case "reconnect":
                        content = `<div class="message-header">ğŸ”„ RECONNECTING</div>`;
                        content += `<div>${
                            data.message || "Attempting to reconnect..."
                        }</div>`;
                        break;
                    case "rtc:incoming":
                        content = `<div class="message-header">ğŸ“ INCOMING RTC CALL</div>`;
                        content += `<div><strong>From:</strong> ${
                            data.sender || "Unknown"
                        }</div>`;
                        break;
                    case "rtc:closed":
                        content = `<div class="message-header">ğŸ“ RTC CLOSED</div>`;
                        content += `<div>${
                            data.message || "RTC connection closed"
                        }</div>`;
                        break;
                    default:
                        content = `<div class="message-header">${type.toUpperCase()}</div>`;
                        content += `<div>${JSON.stringify(data)}</div>`;
                }

                content += `<div class="message-time">${time}</div>`;
                messageItem.innerHTML = content;

                log.appendChild(messageItem);
                log.scrollTop = log.scrollHeight;
            }

            // Realtime callback
            function realtimeCallback(rt) {
                console.log("Realtime message received:", rt);
                addToLog(rt.type, rt);

                // Handle different message types
                if (rt.type === "success") {
                    updateConnectionStatus(true);
                } else if (rt.type === "close" || rt.type === "error") {
                    updateConnectionStatus(false);
                } else if (rt.type === "notice") {
                    // Handle user joined/left notifications
                    if (
                        rt.code === "USER_JOINED" ||
                        rt.code === "USER_LEFT" ||
                        rt.code === "USER_DISCONNECTED"
                    ) {
                        // Refresh user list
                        if (currentGroup) {
                            refreshUserList();
                        }
                    }
                } else if (rt.type === "rtc:incoming") {
                    // Incoming RTC call
                    handleIncomingCall(rt);
                } else if (rt.type === "rtc:closed") {
                    // RTC connection closed
                    handleRTCClosed();
                }
            }

            // Connect to realtime
            async function handleConnect() {
                try {
                    // ê·¸ë£¹ëª…ì´ ì—†ìœ¼ë©´ 'public' ê·¸ë£¹ ì‚¬ìš© (í•„ìˆ˜)
                    const groupName =
                        document.getElementById("groupInput").value.trim() ||
                        "public";
                    currentGroup = groupName;

                    addToLog("info", {
                        message: `Connecting to realtime...`,
                    });

                    // 1ë‹¨ê³„: WebSocket ì—°ê²°
                    realtimeConnection = await skapi.connectRealtime(
                        realtimeCallback
                    );

                    console.log(
                        "Realtime connection established:",
                        realtimeConnection
                    );

                    addToLog("info", {
                        message: `Joining group: ${groupName}...`,
                    });

                    // 2ë‹¨ê³„: ê·¸ë£¹ ì°¸ê°€
                    await skapi.joinRealtime({ group: groupName });

                    addToLog("success", {
                        message: `Successfully joined group: ${groupName}`,
                    });

                    // Load user list
                    refreshUserList();
                } catch (error) {
                    console.error("Failed to connect:", error);
                    addToLog("error", { message: error.message });
                    updateConnectionStatus(false);
                }
            }

            // Disconnect from realtime
            async function handleDisconnect() {
                try {
                    // End call if active
                    if (rtcConnection) {
                        endCall();
                    }

                    await skapi.closeRealtime();
                    realtimeConnection = null;
                    currentGroup = null;
                    document.getElementById("userList").innerHTML =
                        '<p style="text-align: center; color: #666;">ê·¸ë£¹ì— ì°¸ê°€í•˜ë©´ ì‚¬ìš©ì ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤</p>';
                    updateConnectionStatus(false);
                } catch (error) {
                    console.error("Failed to disconnect:", error);
                    addToLog("error", { message: error.message });
                }
            }

            // Send broadcast message
            async function sendMessage() {
                const messageInput = document.getElementById("messageInput");
                const message = messageInput.value.trim();

                if (!message) {
                    alert("Please enter a message");
                    return;
                }

                try {
                    // postRealtime(message, recipient)
                    // recipientëŠ” ê·¸ë£¹ëª… ë˜ëŠ” ì‚¬ìš©ì ID
                    await skapi.postRealtime({ text: message }, currentGroup);

                    addToLog("info", {
                        message: `Message sent to group: ${currentGroup}`,
                    });
                    messageInput.value = "";
                } catch (error) {
                    console.error("Failed to send message:", error);
                    addToLog("error", { message: error.message });
                }
            }

            // Send private message
            async function sendPrivateMessage() {
                const recipientInput =
                    document.getElementById("recipientInput");
                const messageInput = document.getElementById(
                    "privateMessageInput"
                );

                const recipient = recipientInput.value.trim();
                const message = messageInput.value.trim();

                if (!recipient || !message) {
                    alert("Please enter both recipient ID and message");
                    return;
                }

                try {
                    // postRealtime(message, recipient)
                    await skapi.postRealtime({ text: message }, recipient);

                    addToLog("info", {
                        message: `Private message sent to ${recipient}`,
                    });
                    messageInput.value = "";
                } catch (error) {
                    console.error("Failed to send private message:", error);
                    addToLog("error", { message: error.message });
                }
            }

            // Change group
            async function changeGroup() {
                const newGroupName =
                    document.getElementById("changeGroupInput").value.trim() ||
                    null;

                try {
                    await skapi.joinRealtime({ group: newGroupName });

                    currentGroup = newGroupName;
                    document.getElementById("currentGroupName").textContent =
                        currentGroup || "-";
                    document.getElementById("listUsersBtn").disabled =
                        !currentGroup;

                    if (newGroupName) {
                        addToLog("success", {
                            message: `ê·¸ë£¹ ë³€ê²½ë¨: ${newGroupName}`,
                        });
                        refreshUserList();
                    } else {
                        addToLog("success", {
                            message: `ê·¸ë£¹ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤`,
                        });
                        document.getElementById("userList").innerHTML =
                            '<p style="text-align: center; color: #666;">ê·¸ë£¹ì— ì°¸ê°€í•˜ë©´ ì‚¬ìš©ì ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤</p>';
                    }

                    document.getElementById("changeGroupInput").value = "";
                } catch (error) {
                    console.error("Failed to change group:", error);
                    addToLog("error", { message: error.message });
                }
            }

            // List all groups
            async function listGroups() {
                try {
                    const result = await skapi.getRealtimeGroups();

                    addToLog("info", {
                        message: `ì „ì²´ ê·¸ë£¹ ëª©ë¡ (${
                            result.list.length
                        }ê°œ):\n${JSON.stringify(result.list, null, 2)}`,
                    });
                } catch (error) {
                    console.error("Failed to list groups:", error);
                    addToLog("error", { message: error.message });
                }
            }

            // List users in current group
            async function listUsersInGroup() {
                if (!currentGroup) {
                    alert("ê·¸ë£¹ì— ë¨¼ì € ì°¸ê°€í•´ì£¼ì„¸ìš”");
                    return;
                }

                try {
                    const result = await skapi.getRealtimeUsers({
                        group: currentGroup,
                    });

                    addToLog("info", {
                        message: `${currentGroup} ê·¸ë£¹ ì‚¬ìš©ì (${
                            result.list.length
                        }ëª…):\n${JSON.stringify(result.list, null, 2)}`,
                    });
                } catch (error) {
                    console.error("Failed to list users:", error);
                    addToLog("error", { message: error.message });
                }
            }

            // Refresh user list in UI
            async function refreshUserList() {
                if (!currentGroup) return;

                try {
                    const result = await skapi.getRealtimeUsers({
                        group: currentGroup,
                    });
                    const userListDiv = document.getElementById("userList");

                    if (result.list.length === 0) {
                        userListDiv.innerHTML =
                            '<p style="text-align: center; color: #666;">ê·¸ë£¹ì— ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                        return;
                    }

                    userListDiv.innerHTML = "";
                    result.list.forEach((user) => {
                        const userItem = document.createElement("div");
                        userItem.className = "user-item";

                        const isMe = user.user_id === skapi.user.user_id;
                        const userName = isMe
                            ? `${user.user_id} (ë‚˜)`
                            : user.user_id;

                        userItem.innerHTML = `
                            <span>${userName}</span>
                            ${
                                !isMe
                                    ? `<button onclick="callUser('${user.cid}', '${user.user_id}')">ğŸ“ ì „í™”ê±¸ê¸°</button>`
                                    : ""
                            }
                        `;

                        userListDiv.appendChild(userItem);
                    });
                } catch (error) {
                    console.error("Failed to refresh user list:", error);
                }
            }

            // RTC Event Handler
            function RTCEvent(e) {
                console.log("RTC Event:", e);

                if (e.type === "track") {
                    // Incoming Media Stream
                    document.getElementById("remoteVideo").srcObject =
                        e.streams[0];
                    document.getElementById("call_dialog").close();
                    document.getElementById("endCallBtn").disabled = false;

                    addToLog("success", {
                        message: "í†µí™”ê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤",
                    });
                }
            }

            // Call a user
            async function callUser(cid, userId) {
                if (rtcConnection) {
                    alert("ì´ë¯¸ í†µí™” ì¤‘ì…ë‹ˆë‹¤");
                    return;
                }

                try {
                    const call_dialog = document.getElementById("call_dialog");

                    call_dialog.innerHTML = `
                        <p>ğŸ“ ${userId}ì—ê²Œ ì „í™” ê±°ëŠ” ì¤‘...</p>
                        <button onclick="rtcConnection.hangup(); call_dialog.close(); rtcConnection = null;">ì·¨ì†Œ</button>
                    `;
                    call_dialog.showModal();

                    rtcConnection = await skapi.connectRTC(
                        { cid: cid, media: { audio: true, video: true } },
                        RTCEvent
                    );

                    const connection = await rtcConnection.connection;
                    document.getElementById("localVideo").srcObject =
                        connection.media;

                    addToLog("info", {
                        message: `${userId}ì—ê²Œ ì „í™”ë¥¼ ê±¸ê³  ìˆìŠµë‹ˆë‹¤...`,
                    });
                } catch (error) {
                    console.error("Failed to call user:", error);
                    addToLog("error", { message: error.message });
                    document.getElementById("call_dialog").close();
                    rtcConnection = null;
                }
            }

            // Handle incoming call
            function handleIncomingCall(rt) {
                if (rtcConnection) {
                    rt.hangup();
                    return;
                }

                rtcConnection = rt;
                const call_dialog = document.getElementById("call_dialog");

                call_dialog.innerHTML = `
                    <p>ğŸ“ ${rt.sender}ì—ê²Œì„œ ì „í™”ê°€ ì™”ìŠµë‹ˆë‹¤</p>
                    <button onclick="answerCall()">ìˆ˜ë½</button>
                    <button onclick="rejectCall()" class="danger">ê±°ì ˆ</button>
                `;

                call_dialog.showModal();
            }

            // Answer incoming call
            async function answerCall() {
                try {
                    const connection = await rtcConnection.connectRTC(
                        { media: { audio: true, video: true } },
                        RTCEvent
                    );

                    document.getElementById("localVideo").srcObject =
                        connection.media;
                    document.getElementById("endCallBtn").disabled = false;

                    addToLog("success", {
                        message: "ì „í™”ë¥¼ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤",
                    });
                } catch (error) {
                    console.error("Failed to answer call:", error);
                    addToLog("error", { message: error.message });
                    document.getElementById("call_dialog").close();
                    rtcConnection = null;
                }
            }

            // Reject incoming call
            function rejectCall() {
                if (rtcConnection && rtcConnection.hangup) {
                    rtcConnection.hangup();
                }
                document.getElementById("call_dialog").close();
                rtcConnection = null;

                addToLog("info", {
                    message: "ì „í™”ë¥¼ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤",
                });
            }

            // End call
            function endCall() {
                if (rtcConnection) {
                    if (rtcConnection.hangup) {
                        rtcConnection.hangup();
                    }
                    rtcConnection = null;
                }

                document.getElementById("localVideo").srcObject = null;
                document.getElementById("remoteVideo").srcObject = null;
                document.getElementById("endCallBtn").disabled = true;

                addToLog("info", {
                    message: "í†µí™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤",
                });
            }

            // Handle RTC closed
            function handleRTCClosed() {
                rtcConnection = null;
                document.getElementById("localVideo").srcObject = null;
                document.getElementById("remoteVideo").srcObject = null;
                document.getElementById("endCallBtn").disabled = true;

                addToLog("info", {
                    message: "RTC ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤",
                });
            }

            // ==================== NOTIFICATION FUNCTIONS ====================

            /**
             * Converts a Base64 string into a Uint8Array, required for push subscriptions.
             */
            function urlBase64ToUint8Array(base64String) {
                const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
                const base64 = (base64String + padding)
                    .replace(/-/g, "+")
                    .replace(/_/g, "/");

                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);

                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }

                return outputArray;
            }

            // Subscribe to notifications
            async function subscribeToNotifications() {
                try {
                    // Check service worker support
                    if (!("serviceWorker" in navigator)) {
                        alert(
                            "Service workers are not supported in this browser."
                        );
                        return;
                    }

                    // Request notification permission
                    const permission = await Notification.requestPermission();
                    if (permission !== "granted") {
                        alert("Permission not granted for notifications");
                        return;
                    }

                    // Get VAPID key
                    const vapidResponse = await skapi.vapidPublicKey();
                    const vapid = vapidResponse.VAPIDPublicKey;

                    // Register service worker
                    const registration = await navigator.serviceWorker.register(
                        "/sw.js"
                    );
                    await navigator.serviceWorker.ready;

                    // Subscribe to push
                    const subscription =
                        await registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: urlBase64ToUint8Array(vapid),
                        });

                    const subscriptionJSON = subscription.toJSON();
                    console.log("Subscription object:", subscriptionJSON);

                    // Send subscription to Skapi
                    await skapi.subscribeNotification(
                        subscriptionJSON.endpoint,
                        subscriptionJSON.keys
                    );

                    notificationSubscription = subscription;
                    updateNotificationStatus(true);

                    addToLog("success", {
                        message: "ì•Œë¦¼ êµ¬ë…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤",
                    });
                } catch (error) {
                    console.error(
                        "Failed to subscribe to notifications:",
                        error
                    );
                    addToLog("error", { message: error.message });
                }
            }

            // Unsubscribe from notifications
            async function unsubscribeFromNotifications() {
                try {
                    const registration = await navigator.serviceWorker.ready;
                    const subscription =
                        await registration.pushManager.getSubscription();

                    if (!subscription) {
                        alert("ì•Œë¦¼ êµ¬ë…ì´ ë˜ì–´ìˆì§€ ì•ŠìŠµë‹ˆë‹¤");
                        return;
                    }

                    const subscriptionJSON = subscription.toJSON();

                    // Unsubscribe from push
                    await subscription.unsubscribe();

                    // Notify Skapi
                    await skapi.unsubscribeNotification(
                        subscription.endpoint,
                        subscriptionJSON.keys
                    );

                    notificationSubscription = null;
                    updateNotificationStatus(false);

                    addToLog("success", {
                        message: "ì•Œë¦¼ êµ¬ë…ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤",
                    });
                } catch (error) {
                    console.error(
                        "Failed to unsubscribe from notifications:",
                        error
                    );
                    addToLog("error", { message: error.message });
                }
            }

            // Update notification status UI
            function updateNotificationStatus(subscribed) {
                const statusEl = document.getElementById("notificationStatus");
                const subscribeBtn = document.getElementById("subscribeBtn");
                const unsubscribeBtn =
                    document.getElementById("unsubscribeBtn");
                const sendNotifBtn = document.getElementById("sendNotifBtn");

                if (subscribed) {
                    statusEl.textContent = "ì•Œë¦¼ êµ¬ë… ìƒíƒœ: êµ¬ë… ì¤‘ âœ…";
                    statusEl.style.color = "#28a745";
                    subscribeBtn.disabled = true;
                    unsubscribeBtn.disabled = false;
                    sendNotifBtn.disabled = false;
                } else {
                    statusEl.textContent = "ì•Œë¦¼ êµ¬ë… ìƒíƒœ: ë¯¸êµ¬ë…";
                    statusEl.style.color = "#666";
                    subscribeBtn.disabled = false;
                    unsubscribeBtn.disabled = true;
                    sendNotifBtn.disabled = true;
                }
            }

            // Send message with notification
            async function sendMessageWithNotification() {
                const recipient = document
                    .getElementById("notifRecipientInput")
                    .value.trim();
                const title = document
                    .getElementById("notifTitleInput")
                    .value.trim();
                const body = document
                    .getElementById("notifBodyInput")
                    .value.trim();
                const always = document.getElementById("alwaysNotify").checked;

                if (!recipient || !title || !body) {
                    alert("ìˆ˜ì‹ ì, ì œëª©, ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”");
                    return;
                }

                try {
                    const notification = {
                        title: title,
                        body: body,
                    };

                    if (always) {
                        notification.config = { always: true };
                    }

                    await skapi.postRealtime(
                        { text: body },
                        recipient,
                        notification
                    );

                    addToLog("success", {
                        message: `ì•Œë¦¼ê³¼ í•¨ê»˜ ë©”ì‹œì§€ë¥¼ ${recipient}ì—ê²Œ ì „ì†¡í–ˆìŠµë‹ˆë‹¤`,
                    });

                    // Clear inputs
                    document.getElementById("notifTitleInput").value = "";
                    document.getElementById("notifBodyInput").value = "";
                    document.getElementById("alwaysNotify").checked = false;
                } catch (error) {
                    console.error(
                        "Failed to send message with notification:",
                        error
                    );
                    addToLog("error", { message: error.message });
                }
            }

            // Send admin notification (admin only)
            async function sendAdminNotification() {
                const title = document
                    .getElementById("adminNotifTitle")
                    .value.trim();
                const body = document
                    .getElementById("adminNotifBody")
                    .value.trim();
                const targets = document
                    .getElementById("adminNotifTargets")
                    .value.trim();

                if (!title || !body) {
                    alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
                    return;
                }

                try {
                    const notification = {
                        title: title,
                        body: body,
                    };

                    let userIds = null;
                    if (targets) {
                        userIds = targets
                            .split(",")
                            .map((id) => id.trim())
                            .filter((id) => id);
                    }

                    await skapi.pushNotification(notification, userIds);

                    addToLog("success", {
                        message: userIds
                            ? `${userIds.length}ëª…ì˜ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ì„ ì „ì†¡í–ˆìŠµë‹ˆë‹¤`
                            : "ëª¨ë“  êµ¬ë…ìì—ê²Œ ì•Œë¦¼ì„ ì „ì†¡í–ˆìŠµë‹ˆë‹¤",
                    });

                    // Clear inputs
                    document.getElementById("adminNotifTitle").value = "";
                    document.getElementById("adminNotifBody").value = "";
                    document.getElementById("adminNotifTargets").value = "";
                } catch (error) {
                    console.error("Failed to send admin notification:", error);
                    addToLog("error", { message: error.message });
                }
            }

            // Check notification subscription status on load
            async function checkNotificationStatus() {
                try {
                    if ("serviceWorker" in navigator) {
                        const registration = await navigator.serviceWorker
                            .ready;
                        const subscription =
                            await registration.pushManager.getSubscription();
                        if (subscription) {
                            notificationSubscription = subscription;
                            updateNotificationStatus(true);
                        }
                    }
                } catch (error) {
                    console.error(
                        "Failed to check notification status:",
                        error
                    );
                }
            }

            // Handle RTC closed
            function handleRTCClosed() {
                rtcConnection = null;
                document.getElementById("localVideo").srcObject = null;
                document.getElementById("remoteVideo").srcObject = null;
                document.getElementById("endCallBtn").disabled = true;

                addToLog("info", {
                    message: "RTC ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤",
                });
            }

            // Clear log
            function clearLog() {
                document.getElementById("messageLog").innerHTML = "";
            }

            // Initialize
            updateConnectionStatus(false);
            checkNotificationStatus(); // Check notification subscription status

            // Add Enter key support for message inputs
            document
                .getElementById("messageInput")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

            document
                .getElementById("privateMessageInput")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        sendPrivateMessage();
                    }
                });
        </script>
    </body>
</html>
